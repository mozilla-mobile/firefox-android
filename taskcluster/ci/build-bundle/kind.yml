# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---
loader: taskgraph.loader.transform:loader

transforms:
    - android_taskgraph.transforms.build_aab:transforms
    - android_taskgraph.transforms.gradle_optimization:transforms
    - taskgraph.transforms.job:transforms
    - taskgraph.transforms.task:transforms

kind-dependencies:
    - toolchain
    - external-gradle-dependencies

task-defaults:
    aab-artifact-template:
        type: file
        name: 'public/build/target.aab'
        # github-name: '{gradle_build}-{version}.aab'
        path: '/builds/worker/checkouts/vcs/{source_project_name}/app/build/outputs/bundle/{variant}/app-{gradle_build}-{gradle_build_type}.aab'
        # /builds/worker/checkouts/vcs/fenix/app/build/outputs/bundle/fenixDebug/app-fenix-debug.aab
    description: 'Build Fenix AAB from source code'
    fetches:
        toolchain:
            - android-sdk-linux
        external-gradle-dependencies:
            - external-gradle-dependencies.tar.xz
    # TODO optimization:
    # TODO     by-tasks-for:
    # TODO         github-pu(sh|ll-request.*):
    # TODO             skip-unless-changed: [] # Paths are dynamically added by transforms
    # TODO         default: {}
    run:
        using: gradlew
        use-caches: false
        workdir: '/builds/worker'
    treeherder:
        kind: build
        symbol: AAB
        platform: fenix-android-all/opt
        tier: 1
    worker-type: b-android-large
    worker:
        docker-image: {in-tree: base}
        max-run-time: 7200
        chain-of-trust: true


tasks:
    fenix-debug:
        attributes:
            code-review: true
            shipping-product: fenix
        dependencies:
            external-gradle-dependencies: external-gradle-dependencies-fenix
        run-on-tasks-for:
            - github-pull-request
            - github-pull-request-untrusted
            - github-push
        run:
            gradle-build-type: debug
            gradle-build-name: fenixDebug
            gradle-build: fenix
            # track-apk-size: true
        source-project-name: "fenix"
        treeherder:
            symbol: fenix-debug(AAB)
            platform: fenix-android-all/opt

    fenix-release:
        attributes:
            release-type: release
            shipping-product: fenix
        dependencies:
            external-gradle-dependencies: external-gradle-dependencies-fenix
        run-on-tasks-for: []
        # include-shippable-secrets: true
        include-release-version: true
        run:
            gradle-build-type: release
            gradle-build-name: fenixRelease
            gradle-build: fenix
            # track-apk-size: true
        shipping-phase: promote
        source-project-name: "fenix"
        treeherder:
            symbol: fenix-release(AAB)
            platform: fenix-android-all/opt

    fenix-nightly:
        attributes:
            # any tasks that have this as a primary dependency will
            # inherit this attribute via the multi_dep loader
            nightly-task: true
            shipping-product: fenix
        dependencies:
            external-gradle-dependencies: external-gradle-dependencies-fenix
        run-on-tasks-for: []
        # include-shippable-secrets: true
        include-nightly-version: true
        run:
            gradle-build-type: nightly
            gradle-build-name: fenixNightly
            gradle-build: fenix
            # track-apk-size: true
        source-project-name: "fenix"
        treeherder:
            symbol: fenix-nightly(AAB)
            platform: fenix-android-all/opt
